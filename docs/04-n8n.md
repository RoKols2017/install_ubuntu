# Установка n8n с воркером

n8n - это платформа автоматизации workflow с поддержкой распределённых воркеров для масштабирования.

## Предварительные требования

- Docker и Docker Compose установлены ([Этап 2](02-docker-installation.md))
- PostgreSQL (Supabase) установлен и запущен - [см. установку Supabase](03-supabase.md)
- Redis установлен и запущен - [см. установку Redis](05-redis.md)
- Порты: 5678 (Web UI)

## Шаг 1: Создание директорий для данных

```bash
mkdir -p ~/n8n/data
mkdir -p ~/n8n/.n8n
```

## Шаг 2: Настройка переменных окружения

Создаём файл `docker-compose/n8n/.env` (используйте `env.example` как шаблон):

```bash
# Базовые настройки
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=your-secure-password

# База данных PostgreSQL (Supabase)
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=supabase_db
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=postgres
DB_POSTGRESDB_USER=postgres
DB_POSTGRESDB_PASSWORD=your-supabase-password

# Redis для очередей
QUEUE_BULL_REDIS_HOST=redis
QUEUE_BULL_REDIS_PORT=6379
QUEUE_BULL_REDIS_PASSWORD=your-redis-password

# Настройки воркера
N8N_WORKERS_ENABLED=true
N8N_WORKERS_COUNT=2

# Webhook URL (измените на ваш домен)
WEBHOOK_URL=http://localhost:5678/

# Дополнительные настройки
N8N_METRICS=true
N8N_LOG_LEVEL=info
```

## Шаг 3: Запуск n8n

```bash
# Используя скрипт (рекомендуется)
sudo bash scripts/04-setup-n8n.sh

# Или вручную через docker-compose
cd docker-compose/n8n
docker compose up -d
```

## Шаг 4: Проверка работы воркера

```bash
# Проверяем логи основного контейнера
docker logs n8n

# Проверяем логи воркера
docker logs n8n-worker

# Проверяем статус
docker ps | grep n8n
```

Откройте в браузере: `http://localhost:5678`

## Шаг 5: Настройка credentials в n8n

После первого входа настройте credentials:

1. **OpenAI API** - для ChatGPT и embeddings
   - Settings → Credentials → Add Credential → OpenAI
   - Введите ваш API ключ OpenAI

2. **PostgreSQL** - для векторного поиска
   - Settings → Credentials → Add Credential → Postgres
   - Host: `supabase_db` (или `localhost:54322`)
   - Database: `postgres`
   - User: `postgres`
   - Password: из вашего `.env` файла

3. **Redis** - для очередей (обычно настраивается автоматически)

## Интеграция с ChatGPT API

### Создание базового RAG workflow

Пример workflow для RAG (Retrieval Augmented Generation):

1. **Webhook** - принимает запрос
2. **OpenAI Embedding** - создаёт embedding из запроса
3. **Postgres** - поиск похожих документов через `match_documents`
4. **OpenAI Chat** - генерация ответа с контекстом

### Интеграция с векторной БД для RAG

В узле Function после получения embedding:

```javascript
// В узле Function после получения embedding
const queryEmbedding = $input.item.json.embedding;

// Выполняем поиск в Postgres
const similarDocs = await $executeQuery(`
  SELECT * FROM match_documents(
    $1::vector(1536),
    0.7,
    5
  )
`, [queryEmbedding]);

// Формируем контекст для ChatGPT
const context = similarDocs.map(doc => doc.content).join('\n\n');
return { context, query: $input.item.json.query };
```

## Настройка мультиагентной архитектуры

Создайте несколько workflow для разных агентов:
- **Агент поиска** - ищет информацию в векторной БД
- **Агент анализа** - анализирует данные
- **Агент генерации** - создаёт финальный ответ

Связывайте их через webhooks или очереди Redis.

## Масштабирование

### Увеличение количества воркеров

Измените `N8N_WORKERS_COUNT` в `.env` файле и перезапустите:

```bash
docker compose restart n8n-worker
```

### Горизонтальное масштабирование

Можно запустить несколько экземпляров n8n worker на разных серверах, используя общие Redis и PostgreSQL.

## Мониторинг

```bash
# Просмотр логов
docker logs -f n8n
docker logs -f n8n-worker

# Проверка метрик (если включены)
curl http://localhost:5678/metrics
```

## Устранение неполадок

### Проблема: n8n не запускается

```bash
# Проверьте логи
docker logs n8n

# Проверьте подключение к БД
docker exec supabase_db psql -U postgres -c "SELECT 1;"

# Проверьте подключение к Redis
docker exec redis redis-cli -a YOUR_PASSWORD ping
```

### Проблема: Воркер не обрабатывает задачи

```bash
# Проверьте логи воркера
docker logs n8n-worker

# Проверьте настройки Redis
# Убедитесь, что QUEUE_BULL_REDIS_* правильно настроены
```

## Источники

- [Официальная документация n8n](https://docs.n8n.io/)
- [Документация n8n Workers](https://docs.n8n.io/hosting/installation/scaling/)
